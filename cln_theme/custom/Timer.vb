#Region "          Brag          "
'▄▄▄̲̲▄▄̲̲▄▄̲̲▄▄̲̲▄▄̲̲▄▄̲̲▄▄̲̲▄▄̲̲▄▄̲̲▄▄̲̲▄▄▄▄ ▄  ̲̲▄▄̲̲▄▄̲̲▄▄̲̲▄▄̲̲▄▄▄ ̲ ▄    ̲̲ ▄̲   ▄̲̲▄▄̲̲▄▄̲̲▄▄̲̲▄  ▄̲̲▄▄̲̲▄▄̲̲▄̲▄̲̲▄ 
' ▀▀▀▀▀▀▀▀██│██▀▀▀▀▀▀▀▀  █̲̲█│̲̲██̲̲█▀▀▀▀▀▀▀▀  ̲̲██̲̲█│   ̲̲██̲̲█│̲̲██̲̲█▀▀▀▀̲̲██̲̲█│̲̲██̲̲█▀▀▀̲̲██̲̲̲█│
'          ̲̲█▓̲̲█│ ̲̲█▓̲̲█│    ̲̲█▓̲̲█│̲̲█▓̲̲█│         ̲̲█▓̲̲█│   ̲̲█▓̲̲█│̲̲█▓̲̲█│   ̲̲█▓̲̲█│̲̲█▓̲̲█│  ̲̲█▓̲̲█│
'          ̲̲█▒̲̲█│ ̲̲█▒̲̲█│    ̲̲█▒̲̲█│̲̲█▒̲̲█│         ̲̲█▒̲̲█│   ̲̲█▒̲̲█│̲̲█▒̲̲█│   ̲̲█▒̲̲█│̲̲█▒̲̲█│  ̲̲█▒̲̲█│
'          ̲̲█░̲̲█│ ̲̲█░̲̲█│    ̲̲█░̲̲█│█̲̲█̲̲█̲̲▄̲̲▄̲̲▄̲̲▄̲̲▄̲̲▄̲̲▄▄  ̲̲█░█▄▄▄▄̲̲̲︢︢█︢︢︢︢░̲̲█│̲̲█░█▄▄▄▄︢︢︢︢︢█░̲̲█│̲̲█░̲̲█▄▄▄︢︢︢︢███│
'          ̲̲█░̲̲█│ ̲̲█░̲̲█│    ̲̲█░̲̲█│ ▀▀▀▀▀▀▀▀̲̲██̲̲█│̲̲█░̲̲█│   ̲̲█░̲̲█│̲̲█░̲̲█▀▀▀▀̲̲█░̲̲█│̲̲█░̲̲█│  ̲̲█│  
'          ̲̲█▒̲̲█│ ̲̲█▒̲̲█│    ̲̲█▒̲̲█│         ̲̲█▒̲̲█│̲̲█▒̲̲█│   ̲̲█▒̲̲█│̲̲█▒̲̲█│   ̲̲█▒̲̲█│̲̲█▒̲̲█│  █̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲█│ 
'          ̲̲̲█▓̲̲█│ ̲̲█▓̲̲█│    ̲̲█▓̲̲█│         ̲̲█▓̲̲█│̲̲█▓̲̲█│   ̲̲█▓̲̲█│̲̲█▓̲̲█│   ̲̲█▓̲̲█│̲̲█▓̲̲█│   ̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲̲ │
'          █│█│ ▀█̲̲█̲̲▄   ̲̲▄̲̲██▀ ▄▄̲̲▄̲̲▄̲̲▄̲̲▄̲̲▄̲̲▄̲̲▄̲̲█̲̲̲̲̲██│█̲̲̲̲̲██│   █̲̲̲̲̲██│█̲̲̲̲̲̲█̲̲█│   ̲̲█̲̲̲̲̲̲██│̲̲██̲̲█│    │   ̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷
'         ▀▀▀▀▀  ▀███████▀   ▀▀▀▀▀▀▀▀▀     ▀    ▀     ▀    ▀   ̲̲̲̲̲█▓̲̲̲̲̲█│    ̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷̷│̷ ̷
'                             presents...                       ▀     ▀
#End Region

#Region "          Code          "
#Region "Imports"
Imports System.ComponentModel
Imports System.Runtime.InteropServices
#End Region




Module timer
    Public hasTimerStarted As Boolean = 0
    Public T% = 0
    Private WithEvents tmr As Multimedia.Timer
    Private animatedobjects As New List(Of AnimatedObject)
    Public indesignmode As Boolean = 0

    Private Sub startTimer()
        If hasTimerStarted = 0 Then
            tmr = New Multimedia.Timer With {.Period = 1, .Resolution = 1, .Mode = 1}
            tmr.Start()
            hasTimerStarted = 1
        End If
    End Sub
    Private Sub stopTimer()
        If hasTimerStarted = 0 Then Return
        tmr.Stop()
        hasTimerStarted = 0
        tmr.Dispose()
    End Sub
    Public Sub addAnimatedobject(o As AnimatedObject)
        If Not animatedobjects.Contains(o) Then animatedobjects.Add(o)
        If o.designing Then
            indesignmode = 1
            Return
        End If
        startTimer()
    End Sub
    Public Sub removeAnimatedobject(o As AnimatedObject)
        If animatedobjects.Contains(o) Then animatedobjects.Remove(o)
        If animatedobjects.Count = 0 And animatedobjects.Count = 0 Then stopTimer()
    End Sub
    Private Sub tick() Handles tmr.Tick
        If indesignmode = 1 Then Return
        If T >= 1000 Then T = 0
        For Each c As AnimatedObject In animatedobjects
            If c.animating Then c.invalidate()
        Next
        T += 1
    End Sub

End Module









Public Interface AnimatedObject
    ReadOnly Property designing As Boolean
    Property animating As Boolean
    Sub leavemouse(e As EventArgs)

    Sub invalidate()
End Interface







#Region "Multitmedia Timer"
#Region "License"

' Copyright (c) 2006 Leslie Sanford
' * 
' * Permission is hereby granted, free of charge, to any person obtaining a copy 
' * of this software and associated documentation files (the "Software"), to 
' * deal in the Software without restriction, including without limitation the 
' * rights to use, copy, modify, merge, publish, distribute, sublicense, and/or 
' * sell copies of the Software, and to permit persons to whom the Software is 
' * furnished to do so, subject to the following conditions:
' * 
' * The above copyright notice and this permission notice shall be included in 
' * all copies or substantial portions of the Software. 
' * 
' * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR 
' * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, 
' * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE 
' * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER 
' * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, 
' * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN 
' * THE SOFTWARE.
' 

#End Region

#Region "Contact"

'
' * Leslie Sanford
' * Email: jabberdabber@hotmail.com
' 

#End Region

Namespace Multimedia


    ''' <summary>
    ''' Defines constants for the multimedia Timer's event types.
    ''' </summary>
    Public Enum TimerMode
        ''' <summary>
        ''' Timer event occurs once.
        ''' </summary>
        OneShot

        ''' <summary>
        ''' Timer event occurs periodically.
        ''' </summary>
        Periodic
    End Enum

    ''' <summary>
    ''' Represents information about the multimedia Timer's capabilities.
    ''' </summary>
    <StructLayout(LayoutKind.Sequential)>
    Public Structure TimerCaps
        ''' <summary>
        ''' Minimum supported period in milliseconds.
        ''' </summary>
        Public periodMin As Integer

        ''' <summary>
        ''' Maximum supported period in milliseconds.
        ''' </summary>
        Public periodMax As Integer
    End Structure

    ''' <summary>
    ''' Represents the Windows multimedia timer.
    ''' </summary>
    <ToolboxItem(False)> Public NotInheritable Class Timer
        Implements IComponent
#Region "Timer Members"

        'Event disposedb(sender As Object, e As EventArgs)
        '	Event disposed(sender As Object, e As EventArgs)


#Region "Delegates"

        ' Represents the method that is called by Windows when a timer event occurs.
        Public Delegate Sub TimeProc(ByVal id As Integer, ByVal msg As Integer, ByVal user As Integer, ByVal param1 As Integer, ByVal param2 As Integer)

        ' Represents methods that raise events.
        Public Delegate Sub EventRaiser(ByVal e As EventArgs)

#End Region

#Region "Win32 Multimedia Timer Functions"

        ' Gets timer capabilities.
        <DllImport("winmm.dll")>
        Public Shared Function timeGetDevCaps(ByRef caps As TimerCaps, ByVal sizeOfTimerCaps As Integer) As Integer
        End Function

        ' Creates and starts the timer.
        <DllImport("winmm.dll")>
        Public Shared Function timeSetEvent(ByVal delay As Integer, ByVal resolution_Renamed As Integer, ByVal proc As TimeProc, ByVal user As Integer, ByVal mode_Renamed As Integer) As Integer
        End Function

        ' Stops and destroys the timer.
        <DllImport("winmm.dll")>
        Public Shared Function timeKillEvent(ByVal id As Integer) As Integer
        End Function

        ' Indicates that the operation was successful.
        Public Const TIMERR_NOERROR As Integer = 0

#End Region

#Region "Fields"

        ' Timer identifier.
        Public timerID As Integer

        ' Timer mode.
        'TODO: INSTANT VB TODO TASK: There is no VB.NET equivalent to 'volatile':
        'ORIGINAL LINE: public volatile TimerMode mode;
        Public mode_Renamed As TimerMode

        ' Period between timer events in milliseconds.
        'TODO: INSTANT VB TODO TASK: There is no VB.NET equivalent to 'volatile':
        'ORIGINAL LINE: public volatile int period;
        Public period_Renamed As Integer

        ' Timer resolution in milliseconds.
        'TODO: INSTANT VB TODO TASK: There is no VB.NET equivalent to 'volatile':
        'ORIGINAL LINE: public volatile int resolution;
        Public resolution_Renamed As Integer

        ' Called by Windows when a timer periodic event occurs.
        Public timeProcPeriodic As TimeProc

        ' Called by Windows when a timer one shot event occurs.
        Public timeProcOneShot As TimeProc

        ' Represents the method that raises the Tick event.
        Public tickRaiser As EventRaiser

        ' Indicates whether or not the timer is running.
        Public running As Boolean = False

        ' Indicates whether or not the timer has been disposedb.
        'TODO: INSTANT VB TODO TASK: There is no VB.NET equivalent to 'volatile':
        'ORIGINAL LINE: public volatile bool disposedb = False;
        Public disposedb As Boolean = False

        ' The ISynchronizeInvoke object to use for marshaling events.
        Public synchronizingObject_Renamed As ISynchronizeInvoke = Nothing

        ' For implementing IComponent.
        Public site_Renamed As ISite = Nothing

        ' Multimedia timer capabilities.
        Public Shared caps As TimerCaps

#End Region

#Region "Events"

        ''' <summary>
        ''' Occurs when the Timer has started;
        ''' </summary>
        Public Event Started As EventHandler

        ''' <summary>
        ''' Occurs when the Timer has stopped;
        ''' </summary>
        Public Event Stopped As EventHandler

        ''' <summary>
        ''' Occurs when the time period has elapsed.
        ''' </summary>
        Public Event Tick As EventHandler

#End Region

#Region "Construction"

        ''' <summary>
        ''' Initialize class.
        ''' </summary>
        Shared Sub New()
            ' Get multimedia timer capabilities.
            timeGetDevCaps(caps, Marshal.SizeOf(caps))
        End Sub

        ''' <summary>
        ''' Initializes a new instance of the Timer class with the specified IContainer.
        ''' </summary>
        ''' <param name="container">
        ''' The IContainer to which the Timer will add itself.
        ''' </param>
        Public Sub New(ByVal container As IContainer)
            ' Required for Windows.Forms Class Composition Designer support
            container.Add(Me)

            Initialize()
        End Sub

        ''' <summary>
        ''' Initializes a new instance of the Timer class.
        ''' </summary>
        Public Sub New()
            Initialize()
        End Sub

        Protected Overrides Sub Finalize()
            If IsRunning Then
                ' Stop and destroy timer.
                timeKillEvent(timerID)
            End If
        End Sub

        ' Initialize timer with default values.
        Public Sub Initialize()
            Me.mode_Renamed = TimerMode.Periodic
            Me.period_Renamed = Capabilities.periodMin
            Me.resolution_Renamed = 1

            running = False

            timeProcPeriodic = New TimeProc(AddressOf TimerPeriodicEventCallback)
            timeProcOneShot = New TimeProc(AddressOf TimerOneShotEventCallback)
            tickRaiser = New EventRaiser(AddressOf OnTick)
        End Sub

#End Region

#Region "Methods"

        ''' <summary>
        ''' Starts the timer.
        ''' </summary>
        ''' <exception cref="ObjectDisposedException">
        ''' The timer has already been disposedb.
        ''' </exception>
        ''' <exception cref="TimerStartException">
        ''' The timer failed to start.
        ''' </exception>
        Public Sub Start()
            '			#Region "Require"

            If disposedb Then
                Throw New ObjectDisposedException("Timer")
            End If

            '			#End Region

            '			#Region "Guard"

            If IsRunning Then
                Return
            End If

            '			#End Region

            ' If the periodic event callback should be used.
            If Mode = TimerMode.Periodic Then
                ' Create and start timer.
                timerID = timeSetEvent(Period, Resolution, timeProcPeriodic, 0, CInt(Fix(Mode)))
                ' Else the one shot event callback should be used.
            Else
                ' Create and start timer.
                timerID = timeSetEvent(Period, Resolution, timeProcOneShot, 0, CInt(Fix(Mode)))
            End If

            ' If the timer was created successfully.
            If timerID <> 0 Then
                running = True

                If SynchronizingObject IsNot Nothing AndAlso SynchronizingObject.InvokeRequired Then
                    SynchronizingObject.BeginInvoke(New EventRaiser(AddressOf OnStarted), New Object() {EventArgs.Empty})
                Else
                    OnStarted(EventArgs.Empty)
                End If
            Else
                Throw New TimerStartException("Unable to start multimedia Timer.")
            End If
        End Sub

        ''' <summary>
        ''' Stops timer.
        ''' </summary>
        ''' <exception cref="ObjectDisposedException">
        ''' If the timer has already been disposedb.
        ''' </exception>
        Public Sub [Stop]()
            '			#Region "Require"

            If disposedb Then
                Throw New ObjectDisposedException("Timer")
            End If

            '			#End Region

            '			#Region "Guard"

            If (Not running) Then
                Return
            End If

            '			#End Region

            ' Stop and destroy timer.
            Dim result As Integer = timeKillEvent(timerID)

            Debug.Assert(result = TIMERR_NOERROR)

            running = False

            If SynchronizingObject IsNot Nothing AndAlso SynchronizingObject.InvokeRequired Then
                SynchronizingObject.BeginInvoke(New EventRaiser(AddressOf OnStopped), New Object() {EventArgs.Empty})
            Else
                OnStopped(EventArgs.Empty)
            End If
        End Sub

#Region "Callbacks"

        ' Callback method called by the Win32 multimedia timer when a timer
        ' periodic event occurs.
        Public Sub TimerPeriodicEventCallback(ByVal id As Integer, ByVal msg As Integer, ByVal user As Integer, ByVal param1 As Integer, ByVal param2 As Integer)
            If synchronizingObject_Renamed IsNot Nothing Then
                synchronizingObject_Renamed.BeginInvoke(tickRaiser, New Object() {EventArgs.Empty})
            Else
                OnTick(EventArgs.Empty)
            End If
        End Sub

        ' Callback method called by the Win32 multimedia timer when a timer
        ' one shot event occurs.
        Public Sub TimerOneShotEventCallback(ByVal id As Integer, ByVal msg As Integer, ByVal user As Integer, ByVal param1 As Integer, ByVal param2 As Integer)
            If synchronizingObject_Renamed IsNot Nothing Then
                synchronizingObject_Renamed.BeginInvoke(tickRaiser, New Object() {EventArgs.Empty})
                Me.Stop()
            Else
                OnTick(EventArgs.Empty)
                Me.Stop()
            End If
        End Sub

#End Region

#Region "Event Raiser Methods"

        ' Raises the disposedb event.
        Public Sub OnDisposed(ByVal e As EventArgs)
            Dim handler As EventHandler = disposedEvent

            If handler IsNot Nothing Then
                handler(Me, e)
            End If
        End Sub

        ' Raises the Started event.
        Public Sub OnStarted(ByVal e As EventArgs)
            Dim handler As EventHandler = StartedEvent

            If handler IsNot Nothing Then
                handler(Me, e)
            End If
        End Sub

        ' Raises the Stopped event.
        Public Sub OnStopped(ByVal e As EventArgs)
            Dim handler As EventHandler = StoppedEvent

            If handler IsNot Nothing Then
                handler(Me, e)
            End If
        End Sub

        ' Raises the Tick event.
        Public Sub OnTick(ByVal e As EventArgs)
            Dim handler As EventHandler = TickEvent

            If handler IsNot Nothing Then
                handler(Me, e)
            End If
        End Sub

#End Region

#End Region

#Region "Properties"

        ''' <summary>
        ''' Gets or sets the object used to marshal event-handler calls.
        ''' </summary>
        Public Property SynchronizingObject() As ISynchronizeInvoke
            Get
                '				#Region "Require"

                If disposedb Then
                    Throw New ObjectDisposedException("Timer")
                End If

                '				#End Region

                Return synchronizingObject_Renamed
            End Get
            Set(ByVal value As ISynchronizeInvoke)
                '				#Region "Require"

                If disposedb Then
                    Throw New ObjectDisposedException("Timer")
                End If

                '				#End Region

                synchronizingObject_Renamed = value
            End Set
        End Property

        ''' <summary>
        ''' Gets or sets the time between Tick events.
        ''' </summary>
        ''' <exception cref="ObjectDisposedException">
        ''' If the timer has already been disposedb.
        ''' </exception>   
        Public Property Period() As Integer
            Get
                '				#Region "Require"

                If disposedb Then
                    Throw New ObjectDisposedException("Timer")
                End If

                '				#End Region

                Return period_Renamed
            End Get
            Set(ByVal value As Integer)
                '				#Region "Require"

                If disposedb Then
                    Throw New ObjectDisposedException("Timer")
                ElseIf value < Capabilities.periodMin OrElse value > Capabilities.periodMax Then
                    Throw New ArgumentOutOfRangeException("Period", value, "Multimedia Timer period out of range.")
                End If

                '				#End Region

                period_Renamed = value

                If IsRunning Then
                    Me.Stop()
                    Start()
                End If
            End Set
        End Property

        ''' <summary>
        ''' Gets or sets the timer resolution.
        ''' </summary>
        ''' <exception cref="ObjectDisposedException">
        ''' If the timer has already been disposedb.
        ''' </exception>        
        ''' <remarks>
        ''' The resolution is in milliseconds. The resolution increases 
        ''' with smaller values; a resolution of 0 indicates periodic events 
        ''' should occur with the greatest possible accuracy. To reduce system 
        ''' overhead, however, you should use the maximum value appropriate 
        ''' for your application.
        ''' </remarks>
        Public Property Resolution() As Integer
            Get
                '				#Region "Require"

                If disposedb Then
                    Throw New ObjectDisposedException("Timer")
                End If

                '				#End Region

                Return resolution_Renamed
            End Get
            Set(ByVal value As Integer)
                '				#Region "Require"

                If disposedb Then
                    Throw New ObjectDisposedException("Timer")
                ElseIf value < 0 Then
                    Throw New ArgumentOutOfRangeException("Resolution", value, "Multimedia timer resolution out of range.")
                End If

                '				#End Region

                resolution_Renamed = value

                If IsRunning Then
                    Me.Stop()
                    Start()
                End If
            End Set
        End Property

        ''' <summary>
        ''' Gets the timer mode.
        ''' </summary>
        ''' <exception cref="ObjectDisposedException">
        ''' If the timer has already been disposedb.
        ''' </exception>
        Public Property Mode() As TimerMode
            Get
                '				#Region "Require"

                If disposedb Then
                    Throw New ObjectDisposedException("Timer")
                End If

                '				#End Region

                Return mode_Renamed
            End Get
            Set(ByVal value As TimerMode)
                '				#Region "Require"

                If disposedb Then
                    Throw New ObjectDisposedException("Timer")
                End If

                '				#End Region

                mode_Renamed = value

                If IsRunning Then
                    Me.Stop()
                    Start()
                End If
            End Set
        End Property

        ''' <summary>
        ''' Gets a value indicating whether the Timer is running.
        ''' </summary>
        Public ReadOnly Property IsRunning() As Boolean
            Get
                Return running
            End Get
        End Property

        ''' <summary>
        ''' Gets the timer capabilities.
        ''' </summary>
        Public Shared ReadOnly Property Capabilities() As TimerCaps
            Get
                Return caps
            End Get
        End Property

#End Region

#End Region

#Region "IComponent Members"

        Public Event disposed As System.EventHandler Implements IComponent.Disposed

        Public Property Site() As ISite Implements IComponent.Site
            Get
                Return site_Renamed
            End Get
            Set(ByVal value As ISite)
                site_Renamed = value
            End Set
        End Property

#End Region

#Region "IDisposable Members"

        ''' <summary>
        ''' Frees timer resources.
        ''' </summary>
        Public Sub Dispose() Implements System.IDisposable.Dispose
            '			#Region "Guard"

            If disposedb Then
                Return
            End If

            '			#End Region               

            If IsRunning Then
                Me.Stop()
            End If

            disposedb = True

            OnDisposed(EventArgs.Empty)
        End Sub

#End Region
    End Class

    ''' <summary>
    ''' The exception that is thrown when a timer fails to start.
    ''' </summary>
    Public Class TimerStartException
        Inherits ApplicationException
        ''' <summary>
        ''' Initializes a new instance of the TimerStartException class.
        ''' </summary>
        ''' <param name="message">
        ''' The error message that explains the reason for the exception. 
        ''' </param>
        Public Sub New(ByVal message As String)
            MyBase.New(message)
        End Sub
    End Class


End Namespace

#End Region
#End Region